---
title: "Ethiopia Stochastic Frontiers Analysis Draft 2"
author: "Tomas Morley"
date: "20 March 2017"
output:
  pdf_document: default
  word_document:
    reference_docx: ../Common/word_styles_01.docx
bibliography: ../Common/ETHYG.bib
---

```{r setup, include=FALSE}
# Knitr settings
library(rprojroot)
library(dplyr)
root <- find_root(is_rstudio_project)

library(frontier)
library(knitr)
knitr::opts_chunk$set(
  fig.width=12, fig.height=8,
  dpi = 300,
  echo=FALSE, warning=FALSE, message=FALSE,
  fig.path = file.path(root,"FigTabMap/out-"),
  dev = "CairoPNG",
  dev.args = list(CairoPNG = list(bg = "transparent"))
  )

library(pander)
panderOptions('table.alignment.default', function(df)
    ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)
```

# Abstract

We investigate the determinants of the maize yield gap in a nationally representative sample of Ethiopian smallholder farmers.  

# Introduction

# Data

The main data source is the Living Standards Measurement Study - Integrated Surveys on Agriculture (LSMS-ISA) Ethiopian Socioeconomic survey (ESS). This survey was implemented by the Central Statistical Agency of Ethiopia (CSA) and was funded by the World Bank through a grant from the Bill and Melinda Gates foundation. Although part of a panel, the first wave of the ESS did not record crop harvested quantities for a majority of plots making it unsuitable for this analysis. However, the second wave (2013-2014) of the ESS provides detailed information on crop production, input use, environmental and scocioeconomic variables. 

In order to calculate maize yields and input rates, accurate measurements of field areas are required. GPS measurements were recorded for the vast majority of plots in the second wave of the ESS. For those plots lacking a GPS measurement, multiple imputation was used following LSMS-ISA World Bank (2014). Maize yield (`yld`), nitrogen rates (`N`), labour rates (`lab`) and seed rates (`seedha`), are measures of the per hectare application of each variable to a plot. In some cases more than one crop was grown per plot and this is captured in the analysis by the incorporation of variables referring to the number of crops on a field, and whether a field had more than one crop (`crop_count`, `crop_count2`, respectively). Furthermore, variables covering the Ph, soil quality, slope and elevation of the field, and environmental characteristics were also recorded. The longitude and latitude of each household was recorded allowing climate, soil and geographical data to be matched to households from sources including IFPRI, Worlclim, NASA and the Ethiopian Roads Agency amongst others.

## Estimation procedures

The core estimation method in this paper is the stochastic frontiers (SF) method [@Aigner1977; @Meeusen1977]. This involves specification of the form of a production function and a composite error term that reflects both statistical error in the model and an assymetric inefficiency term.

\begin{equation}\label{folstandardform}
y_i = \alpha + f(x_i, \beta) + \epsilon_i
\end{equation}
\begin{equation}\label{folstandardform}
\epsilon_i = v_i - u_i
\end{equation}
\begin{equation}\label{folstandardform}
v_i \sim \mathbb{N}(0, \sigma_v^2)
\end{equation}
\begin{equation}\label{folstandardform}
u_i \sim \mathbb{N}^+(0, \sigma_u^2)
\end{equation}

Where $y_i$ is the log of maize yield and $x_i$ is the log of the inputs including the nitrogen, labour and seed rates. The composite error term $\epsilon_i$ includes a truncated normal inefficiency term $u_i$ and a statistical error term $v_i$ where $u$ and $v$ are independent. [@Aigner1977] show that the composite error term $\epsilon_i$ follows the following density

\begin{equation}\label{folstandardform}
f_\epsilon(\epsilon_i) = \frac{2}{\sigma}\phi(\frac{\epsilon_i}{\sigma})\Phi(-\frac{\lambda\epsilon_i}{\sigma})
\end{equation}

Given a suitable functional form $f(.)$ The parameters of the stochastic frontiers model can be estimated using maximum likelihood (ML) estimation. Common production functions that have been used in crop yield models include the Cobb Douglass and translog production functions. The translog is the more flexible of the two and includes the squares and interactions of the inputs. In addition we can append environmental variables such as the slope and elevation of the plot to the chosen production form yielding the following model in the translog case:

\begin{equation}\label{folstandardform}
y_i = \alpha + \sum_{k=1}^K \beta_k x_{ik} \sum_{k=1}^K \sum_{j=1}^K \gamma_{jk}x_{ij} x_{ik} + W_i \theta + \epsilon_i
\end{equation}

Where $W_i$ are the environmental variables. With a slight modification to the density of $\epsilon_i$ we can allow the mean of the inefficiency term $u_i$ to depend on exogenous factors that explain technical inefficiency such as education, age and access to markets. 

## Results

The resulting SF ML estimates are presented in table 1 for four models. Model 1 shows the coefficient estimates for the core translog production function terms. Model 2 extend this to include the exogenous determinants of inefficiences. Models 3 and 4 do likewise and also include the environmental variables.

```{r}
source(file.path(root, "Code/production_function_tests.R"))
pander(results_tab)
```

The raw coefficients of the exogenous determinants of technical inefficinecy cannot be interpreted as elasticities. However, the marginal effects of each variable can be computed following Kumbhakar & Sun (2013). These are observation specific and a concise estimate of the marginal effects is presented in table 2 in the form of the average partial effects (APE) for models 2 and 4 respectively. 

```{r}
pander(ME_tab)
```

Although we control for a range of environmental variables, several studies have investigated the possibility of endogeneity between nitrogen and maize yield (Liverpool tasie, smale and mason, etc etc). Endogeneity may occur in the presence of a feedback loop between the error term and the choice of inputs (Amsler 2016). In the stochastic frontiers setting this may involve either the statistical error term, the inefficiency term or both. One way of testing for the presence of endogeneity is to employ a control function approach, estimating a first stage reduced form model for the endogenous variable and using the predicted residuals as a regressor in a second stage full structural model. The null hypothesis that the endogenous variable is exogenous is rejected based on the significance of a standard t or F test. The control function approach is an alternative to two stage least squares estimation which is suitable when using a nonlinear second stage estimation such as in the case of a translog production function. It has the additional advantage that only one control function is required per endogenous inputs, rather than four, corresponding to the four terms involving nitrogen, that would be required in 2SLS setting. 

```{r echo=FALSE}
FS_tab <- readRDS(file.path(root, "Report/tables/FS_endog_tab.rds"))
SS_tab <- readRDS(file.path(root, "Report/tables/SS_endog_tab.rds"))
```

```{r}
pander(FS_tab)
```

```{r}
pander(SS_tab)
```

Although incorporating the residuals from the reduced form regression tests for endogeneity it does not provide suitable estimation in a stochastic frontiers framework. In other words, knowing that nitrogen is endogenous to the relationship does not take us closer to estimating the frontier function. Instead, a recent survey of methods for incorporating endogeneity in stochastic frontiers models suggests the use of corrected two stage least squares (C2SLS) or Limited information maximum likelihood (LIML) as frameworks for estimating the stochastic frontiers model. We cannot add fitted values for the endogenous variable to the normal COLS or SF ML estimation. Moreover, the composite error term $epsilon_i$ may be correlated with either the statistical noise or the inefficinecy and additional assumptions are required to determine which. determine this based on what could lead to inefficinecy 
Endogeneity formally refers to the situation where the residuals in the estimation are correlated with an explanatory variable. In this case the explanatory variable is then referred to as the endogenous variable. For our estimation we focus on the potential endogeneity of nitrogen which enters the translog production function in a log level term and a log squared term. As a result we need a minimum of two identifying equations in order to be able to estimate with a control function and remove the endogeneityLIML outperforms 2sls when the instruments are weak or when there are many instruments relative to the number of observations

control functions are used to break the correlation between the endogenous variables and unobservables affecting the response (Wooldrdige 2010) and are often used to handle endogeneity in non-linear models when techniques such as two stage least squares are not applicable. Similar to two stage least squares this approach requires exogenous variables which do not appear in the second stage or structural regression but do appear in the first stage regression. In other words, variables which affect the quantity of nitrogen used, but not the yield response equation.

So due to the squared term on nitrogen we say that this model is nonlinear in the endogenous variable
We should be careful to include all terms that appear in the second stage in the first stage, with the exception of the endogenous variable which appears as the dependent variable on the right hand side.
When we have a translog (nonlinear function) special attention is needed for identification and choice of instruments.
Feedback loop in the sense that you can write yield as a function of nitrogen but you can also write nitrogen as a function of yield.
We make the assumption that the endogenous variable is correlated with statistical noise but not with inefficiency.
If nitrogen is correlated with the statistical error term then we also expected its square to be correlated with that term too.
In the presense of endogeneity the maximum likelihood estimates of the stochastic frontiers model will not be consistent. 

